// Service pour interagir avec l'API Catalogue via Supabase Edge Functions
import { supabase } from '@/integrations/supabase/client';
import type { Product, Company, Category, CategoryType, Brand, CatalogResponse, ApiError } from './types-catalog';

export class ApiService {
  private companySlug: string;

  constructor(companySlug: string) {
    this.companySlug = companySlug;
  }

  /**
   * Gère les erreurs de l'API de manière standardisée
   */
  private handleApiError(error: any): ApiError {
    console.error('API Error:', error);
    return {
      message: error.message || 'Une erreur est survenue',
      code: error.code,
      details: error.details
    };
  }

  /**
   * Appel générique aux Edge Functions Supabase (GET)
   */
  private async edgeFunctionCall<T>(
    companySlug: string,
    endpoint: string,
    params?: Record<string, string>
  ): Promise<T> {
    try {
      const queryParams = params ? `?${new URLSearchParams(params).toString()}` : '';
      const { data, error } = await supabase.functions.invoke('catalog-api', {
        body: {},
        method: 'GET',
      });

      if (error) throw error;
      return data as T;
    } catch (error) {
      throw this.handleApiError(error);
    }
  }

  /**
   * Appel générique aux Edge Functions Supabase (POST)
   */
  private async edgeFunctionPost<T>(
    companySlug: string,
    endpoint: string,
    postData: any
  ): Promise<T> {
    try {
      const { data, error } = await supabase.functions.invoke('catalog-api', {
        body: postData,
        method: 'POST',
      });

      if (error) throw error;
      return data as T;
    } catch (error) {
      throw this.handleApiError(error);
    }
  }

  /**
   * Récupère les informations de l'entreprise par son slug
   */
  async getCompanyBySlug(slug: string): Promise<Company | null> {
    try {
      const response = await this.edgeFunctionCall<{ company: Company }>(
        slug,
        'company'
      );
      return response.company;
    } catch (error) {
      console.error('Error fetching company:', error);
      return null;
    }
  }

  /**
   * Récupère le catalogue public de produits avec filtres optionnels
   */
  async getPublicCatalog(
    companySlug: string,
    filters?: {
      search?: string;
      category?: string;
      brands?: string[];
      priceRange?: [number, number];
      page?: number;
      limit?: number;
    }
  ): Promise<CatalogResponse> {
    try {
      const params: Record<string, string> = {};
      
      if (filters?.search) params.search = filters.search;
      if (filters?.category) params.category = filters.category;
      if (filters?.brands?.length) params.brands = filters.brands.join(',');
      if (filters?.priceRange) {
        params.minPrice = filters.priceRange[0].toString();
        params.maxPrice = filters.priceRange[1].toString();
      }
      if (filters?.page) params.page = filters.page.toString();
      if (filters?.limit) params.limit = filters.limit.toString();

      return await this.edgeFunctionCall<CatalogResponse>(
        companySlug,
        'products',
        params
      );
    } catch (error) {
      throw this.handleApiError(error);
    }
  }

  /**
   * Récupère un produit spécifique par son slug
   */
  async getProductBySlug(
    companySlug: string,
    productSlug: string
  ): Promise<Product | null> {
    try {
      const response = await this.edgeFunctionCall<{ product: Product }>(
        companySlug,
        `products/${productSlug}`
      );
      return response.product;
    } catch (error) {
      console.error('Error fetching product:', error);
      return null;
    }
  }

  /**
   * Récupère un produit spécifique par son ID
   */
  async getProductById(
    companySlug: string,
    productId: string
  ): Promise<Product | null> {
    try {
      const response = await this.edgeFunctionCall<{ product: Product }>(
        companySlug,
        `products/${productId}`
      );
      return response.product;
    } catch (error) {
      console.error('Error fetching product:', error);
      return null;
    }
  }

  /**
   * Récupère la liste des catégories avec leurs types enrichis
   */
  async getCategories(companySlug: string): Promise<{ categories: Category[] }> {
    try {
      return await this.edgeFunctionCall<{ categories: Category[] }>(
        companySlug,
        'categories'
      );
    } catch (error) {
      throw this.handleApiError(error);
    }
  }

  /**
   * Récupère les types de catégories disponibles avec leurs propriétés visuelles
   */
  async getCategoryTypes(): Promise<{ category_types: CategoryType[] }> {
    try {
      return await this.edgeFunctionCall<{ category_types: CategoryType[] }>(
        this.companySlug,
        'category-types'
      );
    } catch (error) {
      throw this.handleApiError(error);
    }
  }

  /**
   * Récupère les compatibilités entre types de catégories
   */
  async getCategoryCompatibilities(): Promise<{ compatibilities: Record<string, string[]> }> {
    try {
      return await this.edgeFunctionCall<{ compatibilities: Record<string, string[]> }>(
        this.companySlug,
        'compatibilities'
      );
    } catch (error) {
      throw this.handleApiError(error);
    }
  }

  /**
   * Récupère les personnalisations pour l'entreprise
   */
  async getCustomizations(companySlug: string): Promise<any> {
    try {
      return await this.edgeFunctionCall<any>(
        companySlug,
        'customizations'
      );
    } catch (error) {
      throw this.handleApiError(error);
    }
  }

  /**
   * Soumet un panier (devis ou commande)
   */
  async submitCart(
    companySlug: string,
    cartData: {
      items: any[];
      customerInfo: {
        email: string;
        name: string;
        company?: string;
        phone?: string;
      };
      type: 'quote' | 'order';
    }
  ): Promise<{ success: boolean; id?: string; message?: string }> {
    try {
      return await this.edgeFunctionPost<{ success: boolean; id?: string; message?: string }>(
        companySlug,
        'cart/submit',
        cartData
      );
    } catch (error) {
      throw this.handleApiError(error);
    }
  }
}
